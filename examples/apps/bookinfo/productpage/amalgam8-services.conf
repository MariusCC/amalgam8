include /etc/nginx/amalgam8-access-logging.conf;
include /etc/nginx/amalgam8-dynupstreams.conf;
include /etc/nginx/nginx-customizations.conf;

### A8 Sidecar proxy configuration
server {
       listen 6379;

       ## Comment the previous line and enable the latter two if you are using the sidecar as a gateway
       #listen 80;
       #listen 443 ssl;

       ## For using the A8 proxy as a gateway with SSL support
       # eventhough the key and cert are stored in same file, only cert is
       # sent to client
       #ssl_certificate /path/to/cert;
       #ssl_certificate_key /path/to/key;

       #location ~ ^/(?<service_name>.*?)(?<reqpath>/(.*))?$ {
       #  include /etc/nginx/amalgam8-rules.conf;
         # Add proxy SSL verification directives here:
         # proxy_ssl_trusted_certificate /path/to/trusted_ca_cert_list.crt;
         # proxy_ssl_verify        on;
         # proxy_ssl_verify_depth  2;
         # proxy_ssl_session_reuse on;
       #}

       # Other location blocks
       location / {
       set_by_lua_block $a8_source_service { return amalgam8:get_myname() }
       set_by_lua_block $a8_source_tags { return amalgam8:get_mytags() }
       set $a8_upstream_name nil;
       set $a8_upstream_tags nil;
       set $a8_upstream_instance nil;
       set $a8_trace_key nil;
       set $a8_trace_value nil;
       set $a8_service_type 'http';
       set $a8_upstream_host $host;
       set $service_name $host;

       access_by_lua_block {
          amalgam8:apply_rules()
       }
       proxy_set_header Host $a8_upstream_host;
       proxy_pass $a8_service_type://a8_upstreams;

       ## websocket auto-upgrade
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection $connection_upgrade;
      }

       access_log /var/log/nginx/a8_access.log a8log;
}
